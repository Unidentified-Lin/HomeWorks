<!DOCTYPE html>
<html>
	<head>
		<title>Mask Map</title>
		<script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
		<script
			src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA_3-kFPPfrudPskxlcu4sHsykFAjMrJFg&callback=initMap&libraries=&v=weekly&region=TW"
			defer
		></script>
		<style>
			/* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
			#map {
				height: 100%;
			}

			/* Optional: Makes the sample page fill the window. */
			html,
			body {
				height: 100%;
				margin: 0;
				padding: 0;
			}
		</style>
	</head>
	<body>
		<div id="map"></div>
		<!-- <script src="./uni_fetch.js"></script> -->
		<script>
			const maskUrl = "https://maskmap.azurewebsites.net/api/mask/getmaskstock";
			let basePath = "./assets/mask-";
			window.onload = function () {
				googleMap.data.loadGeoJson(maskUrl);
				googleMap.data.setStyle(function (feature) {
					let name = feature.getProperty("name");
					let masksLeft = feature.getProperty("masksLeft");
					let childMasksLeft = feature.getProperty("childMasksLeft");
					let iconPath = basePath + maskLevel(masksLeft, childMasksLeft);

					return {
						icon: iconPath,
						title: `成人：${masksLeft} 小孩：${childMasksLeft}`,
					};
				});
				let infowindow = new google.maps.InfoWindow();
				googleMap.data.addListener("click", function (event) {
					let feature = event.feature;
					let name = feature.getProperty("name");
					let masksLeft = feature.getProperty("masksLeft");
					let childMasksLeft = feature.getProperty("childMasksLeft");
					infowindow.setContent(genInfoContent(name, masksLeft, childMasksLeft));
					infowindow.setPosition(event.latLng);
					infowindow.setOptions({ pixelOffset: new google.maps.Size(0, -34) });
					infowindow.open(googleMap);
				});
			};
			function maskLevel(masks, childMasks) {
				// let total = masks + childMasks;
				let total = masks;

				if (total == 0) {
					return "red.png";
				} else if (total <= 60) {
					return "yellow.png";
				} else {
					return "green.png";
				}
			}
			function genInfoContent(name, masks, childMasks) {
				return (
					'<div class="content">' +
					`<h1 id="firstHeading" class="firstHeading">${name}</h1>` +
					`<p>成人口罩：${masks} ｜ 小孩口罩：${childMasks}</p>` +
					"</div>"
				);
			}

			var googleMap;
			function initMap() {
				const geocoder = new google.maps.Geocoder();

				googleMap = new google.maps.Map(document.getElementById("map"), { zoom: 18 });
				const address = "台北市大安區忠孝東路三段Build School樓之1";
				setAddressCenter(geocoder, googleMap, address);
			}
		</script>
		<script>
			function getGeocodeLatLng(geocoder, address) {
				return new Promise(function (resolve, reject) {
					geocoder.geocode({ address: address }, (results, status) => {
						if (status === "OK") {
							resolve(results[0].geometry.location);
						} else {
							reject(status);
						}
					});
				});
			}

			function setAddressCenter(geocoder, resultsMap, address) {
				getGeocodeLatLng(geocoder, address).then(
					function (location) {
						resultsMap.setCenter(location);
					},
					function (status) {
						alert("Geocode was not successful for the following reason: " + status);
					}
				);
			}
			function pinAddressMark(geocoder, resultsMap, address) {
				getGeocodeLatLng(geocoder, address).then(
					function (location) {
						resultsMap.setCenter(location);
						new google.maps.Marker({
							map: resultsMap,
							position: location,
						});
					},
					function (status) {
						alert("Geocode was not successful for the following reason: " + status);
					}
				);
			}
		</script>
	</body>
</html>
